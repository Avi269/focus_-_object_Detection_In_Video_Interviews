{% extends 'base.html' %}
{% load static %}

{% block title %}Interviews - Proctoring System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-calendar"></i> 
            {% if user.role == 'candidate' %}My Interviews{% else %}Interviews{% endif %}
        </h2>
        {% if user.role == 'admin' or user.role == 'interviewer' %}
            <a href="{% url 'interviews:schedule_interview' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Schedule Interview
            </a>
        {% endif %}
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>Scheduled</option>
                        <option value="ongoing" {% if status_filter == 'ongoing' %}selected{% endif %}>Ongoing</option>
                        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="search" class="form-label">Search</label>
                    <input type="text" name="search" id="search" class="form-control" 
                           placeholder="Search by title, candidate, or interviewer..." 
                           value="{{ search_query|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search"></i> Filter
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            {% if page_obj %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Interview</th>
                                <th>Candidate</th>
                                <th>Interviewer</th>
                                <th>Scheduled Time</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for interview in page_obj %}
                                <tr>
                                    <td>
                                        <strong>{{ interview.title|default:"Interview Session" }}</strong>
                                        {% if interview.description %}
                                            <br><small class="text-muted">{{ interview.description|truncatewords:8 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                                <i class="fas fa-user text-white small"></i>
                                            </div>
                                            <div>
                                                <strong>{{ interview.candidate.username }}</strong>
                                                <br>
                                                <small class="text-muted">{{ interview.candidate.get_full_name|default:"No name provided" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-success rounded-circle d-flex align-items-center justify-content-center me-2">
                                                <i class="fas fa-user-tie text-white small"></i>
                                            </div>
                                            <div>
                                                <strong>{{ interview.interviewer.username }}</strong>
                                                <br>
                                                <small class="text-muted">{{ interview.interviewer.get_full_name|default:"No name provided" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ interview.scheduled_time|date:"M d, Y" }}</strong>
                                            <br>
                                            <small class="text-muted">{{ interview.scheduled_time|date:"H:i" }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if interview.status == 'completed' %}success{% elif interview.status == 'ongoing' %}warning{% elif interview.status == 'scheduled' %}info{% else %}secondary{% endif %} fs-6">
                                            {% if interview.status == 'completed' %}
                                                <i class="fas fa-check-circle me-1"></i>
                                            {% elif interview.status == 'ongoing' %}
                                                <i class="fas fa-circle me-1"></i>
                                            {% elif interview.status == 'scheduled' %}
                                                <i class="fas fa-clock me-1"></i>
                                            {% endif %}
                                            {{ interview.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if interview.get_duration_display %}
                                            <strong>{{ interview.get_duration_display }}</strong>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <!-- View Button - Always Available -->
                                            <a href="{% url 'interviews:interview_detail' interview.id %}" 
                                               class="btn btn-sm btn-outline-primary" 
                                               title="View Interview Details">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                            
                                            <!-- Candidate Actions -->
                                            {% if user.role == 'candidate' %}
                                                {% if interview.status == 'scheduled' %}
                                                    <a href="{% url 'interviews:join' interview.id %}" 
                                                       class="btn btn-sm btn-success"
                                                       title="Join Interview">
                                                        <i class="fas fa-door-open"></i> Join
                                                    </a>
                                                {% elif interview.status == 'ongoing' %}
                                                    <a href="{% url 'interviews:live' interview.id %}" 
                                                       class="btn btn-sm btn-danger"
                                                       title="Join Live Interview">
                                                        <i class="fas fa-video"></i> Live
                                                    </a>
                                                {% endif %}
                                            
                                            <!-- Admin/Interviewer Actions -->
                                            {% elif user.role == 'admin' or user.role == 'interviewer' %}
                                                {% if interview.status == 'scheduled' %}
                                                    <a href="{% url 'interviews:start_interview' interview.id %}" 
                                                       class="btn btn-sm btn-success"
                                                       title="Start Interview">
                                                        <i class="fas fa-play"></i> Start
                                                    </a>
                                                {% elif interview.status == 'ongoing' %}
                                                    <!-- Use POST form so view will execute POST stop logic -->
                                                    <form action="{% url 'interviews:end_interview' interview.id %}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to end this interview? This action cannot be undone.');">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-sm btn-danger" title="End Interview">
                                                            <i class="fas fa-stop"></i> End
                                                        </button>
                                                    </form>
                                                {% endif %}
                                                
                                                <!-- Additional Actions for Completed Interviews -->
                                                {% if interview.status == 'completed' %}
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" 
                                                                data-bs-toggle="dropdown" aria-expanded="false"
                                                                title="More Actions">
                                                            <i class="fas fa-ellipsis-h"></i>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li>
                                                                <a class="dropdown-item" href="{% url 'interviews:upload_recording' interview.id %}">
                                                                    <i class="fas fa-upload me-2"></i>Upload Recording
                                                                </a>
                                                            </li>
                                                            {% if user.is_staff %}
                                                            <li>
                                                                <a class="dropdown-item" href="{% url 'admin:index' %}">
                                                                    <i class="fas fa-cog me-2"></i>Admin Panel
                                                                </a>
                                                            </li>
                                                            {% endif %}
                                                        </ul>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                    <nav aria-label="Interview pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" title="First Page">
                                        <i class="fas fa-angle-double-left"></i> First
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" title="Previous Page">
                                        <i class="fas fa-angle-left"></i> Previous
                                    </a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" title="Next Page">
                                        Next <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" title="Last Page">
                                        Last <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                        
                        <!-- Page Info -->
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} 
                                of {{ page_obj.paginator.count }} interviews
                            </small>
                        </div>
                    </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-calendar-times fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Interviews Found</h4>
                    <p class="text-muted mb-4">
                        {% if user.role == 'candidate' %}
                            You don't have any interviews scheduled at the moment.
                            <br>
                            <small>Check back later or contact your interviewer.</small>
                        {% else %}
                            There are no interviews scheduled at the moment.
                            <br>
                            <small>Get started by scheduling your first interview.</small>
                        {% endif %}
                    </p>
                    {% if user.role == 'admin' or user.role == 'interviewer' %}
                        <a href="{% url 'interviews:schedule_interview' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus me-2"></i> Schedule First Interview
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 🔧 FIXED: Statistics Cards with proper data from view -->
    {% if stats %}
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-check text-success fa-2x mb-2"></i>
                    <h5>{{ stats.total }}</h5>
                    <small class="text-muted">Total Interviews</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clock text-info fa-2x mb-2"></i>
                    <h5>{{ stats.scheduled }}</h5>
                    <small class="text-muted">Scheduled</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-play-circle text-warning fa-2x mb-2"></i>
                    <h5>{{ stats.ongoing }}</h5>
                    <small class="text-muted">Ongoing</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                    <h5>{{ stats.completed }}</h5>
                    <small class="text-muted">Completed</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- 🔧 Add some custom CSS for better appearance -->
<style>
.avatar-sm {
    width: 32px;
    height: 32px;
}

.btn-group .dropdown-toggle::after {
    margin-left: 0;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.badge {
    font-weight: 500;
}

.pagination .page-link {
    border-radius: 0.375rem;
    margin: 0 2px;
    border: 1px solid #dee2e6;
}

.pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add tooltips to all buttons with title attribute
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Add confirmation for end interview actions
    document.querySelectorAll('a[href*="end_interview"]').forEach(function(link) {
        link.addEventListener('click', function(e) {
            if (!confirm('Are you sure you want to end this interview? This action cannot be undone.')) {
                e.preventDefault();
                return false;
            }
        });
    });
    
    // Add loading state for POST forms: attach to form submit so button isn't disabled before submit
    document.querySelectorAll('form').forEach(function(frm) {
        frm.addEventListener('submit', function(e) {
            try {
                // find the submit button inside the form
                const submitBtn = frm.querySelector('button[type="submit"], input[type="submit"]');
                if (submitBtn && (submitBtn.classList.contains('btn-danger') || submitBtn.classList.contains('btn-success') || submitBtn.classList.contains('btn-primary'))) {
                    const originalHtml = submitBtn.innerHTML;
                    // apply spinner slightly after to allow default submit to proceed
                    setTimeout(() => {
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        submitBtn.disabled = true;
                    }, 20);

                    // restore after 5 seconds if page doesn't reload
                    setTimeout(() => {
                        try { submitBtn.innerHTML = originalHtml; submitBtn.disabled = false; } catch(_){}
                    }, 5000);
                }
            } catch (err) {
                console.error('Submit spinner error', err);
            }
        });
    });
    
    console.log('Interview list page loaded successfully');

    // Fallback: ensure any end interview forms get submitted (helps if other handlers block submit)
    try {
        document.querySelectorAll('form[action*="/end/"]').forEach(function(frm) {
            frm.addEventListener('submit', function() {
                console.log('Submitting end form to', frm.action);
            });

            // force submit on button click after a tiny delay to avoid other preventDefault handlers
            frm.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    console.log('End button clicked for form', frm.action);
                    setTimeout(function() {
                        try { if (document.activeElement === btn) frm.submit(); } catch(e) { console.error(e); }
                    }, 30);
                });
            });
        });
    } catch (e) { console.error('End form fallback error', e); }
});
</script>
{% endblock %}
